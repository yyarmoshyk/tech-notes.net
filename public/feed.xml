<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.8.5">Jekyll</generator><link href="/feed.xml" rel="self" type="application/atom+xml" /><link href="/" rel="alternate" type="text/html" /><updated>2020-10-27T08:56:51+00:00</updated><id>/feed.xml</id><title type="html">Tech Notes</title><subtitle>Полезные записки</subtitle><author><name>Yaroslav Yarmoshyk</name></author><entry><title type="html">Jenkins auth over AWS Cognito</title><link href="/jenkins-login-with-cognito-in-aws/" rel="alternate" type="text/html" title="Jenkins auth over AWS Cognito" /><published>2020-10-27T00:00:00+00:00</published><updated>2020-10-27T00:00:00+00:00</updated><id>/jenkins-login-with-cognito-in-aws</id><content type="html" xml:base="/jenkins-login-with-cognito-in-aws/">&lt;p&gt;Recently I had a case where I had to enforce the following options for Jenkins:&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;Password policy (length, secial characters)&lt;/li&gt;
  &lt;li&gt;MFA&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;None of the plugins supports this but AWS Cognito does. Unfortunately there is no native Jenkins Cognito plugin so I stated to dig into &lt;a href=&quot;https://plugins.jenkins.io/oic-auth/&quot;&gt;OpenId Connect Authentication&lt;/a&gt; jenkins plugin and it worked.&lt;/p&gt;

&lt;p&gt;Next I’m going to describe the steps it took me to configure the cognito-jenkins connection.&lt;/p&gt;

&lt;h2 id=&quot;cognito-configuration&quot;&gt;Cognito configuration&lt;/h2&gt;
&lt;ol&gt;
  &lt;li&gt;In AWS console find the “Cognito” section, select “Manage userpools” and select “Create a userpool”.&lt;/li&gt;
  &lt;li&gt;In the initial screen specify the name of the pool and select “Step through settings”&lt;/li&gt;
  &lt;li&gt;On the second screen make sure to select the following options:
    &lt;ol&gt;
      &lt;li&gt;Which standard attributes are required:
        &lt;ul&gt;
          &lt;li&gt;email&lt;/li&gt;
          &lt;li&gt;phone_number&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;On the next screen:
    &lt;ol&gt;
      &lt;li&gt;Specify the desired password options (length, require numbers, etc.) according to the security policy of your organization.&lt;/li&gt;
      &lt;li&gt;In our case we don’t want to allow users sign up for jenkins access so select “Only allow administrators to create users”&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;On the next screen make sure to select the following options:
    &lt;ol&gt;
      &lt;li&gt;Do you want to enable Multi-Factor Authentication?:
        &lt;ul&gt;
          &lt;li&gt;required&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Which second factors do you want to enable:
        &lt;ul&gt;
          &lt;li&gt;SMS text message&lt;/li&gt;
          &lt;li&gt;Time-based One-time Password&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;How will a user be able to recover their account?:
        &lt;ul&gt;
          &lt;li&gt;Email only&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Which attributes do you want to verify?:
        &lt;ul&gt;
          &lt;li&gt;Phone number&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;You must provide a role to allow Amazon Cognito to send SMS messages:
        &lt;ul&gt;
          &lt;li&gt;this is either existing role or the name of the IAM role to be created for you.&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;On the next screen you can customize notifications at you desire. I will not describe it. I’ll focus on hte items we need to select for this setup:
    &lt;ol&gt;
      &lt;li&gt;Do you want to send emails through your Amazon SES Configuration:
        &lt;ul&gt;
          &lt;li&gt;No - Use Cognito (Default)&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;On the next screen you can add tags to the userpool according to your organisation needs.&lt;/li&gt;
  &lt;li&gt;Do you want to remember your user’s devices:
    &lt;ul&gt;
      &lt;li&gt;User Opt In&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;On the next screen you can add the application client that will be working with this pool. Click “Add an app client”:
    &lt;ul&gt;
      &lt;li&gt;Specify App client name (it will be jenkins in our case)&lt;/li&gt;
      &lt;li&gt;Select “Enable username password based authentication (ALLOW_USER_PASSWORD_AUTH)”&lt;/li&gt;
      &lt;li&gt;Uncheck “Enable lambda trigger based custom authentication (ALLOW_CUSTOM_AUTH)”
Click “Create app client” button on the bottom of the screen.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Triggers page can be skipped.&lt;/li&gt;
  &lt;li&gt;On the review page click “Create pool” button on the bottom.&lt;/li&gt;
  &lt;li&gt;You’ll be redirected to the recently created userpool page.&lt;/li&gt;
  &lt;li&gt;Find the “Domain name” section
    &lt;ul&gt;
      &lt;li&gt;On this page you’ll need to specify the unique domain name prefix. It can be verified by clicking the “Check availability button”. I’d recommend to use “jenkins-${company_name}-${some_random_string}”. Click “Save changes” when done.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Go to “App clients” and click “Show details.” Note the values of the following:
    &lt;ul&gt;
      &lt;li&gt;App client id&lt;/li&gt;
      &lt;li&gt;App client secret&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Go to “App client settings”:
    &lt;ol&gt;
      &lt;li&gt;Enabled Identity Providers
        &lt;ul&gt;
          &lt;li&gt;“Select all”&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Callback URL(s):
        &lt;ul&gt;
          &lt;li&gt;https://${jenkins-url}/securityRealm/finishLogin&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Sign out URL(s)
        &lt;ul&gt;
          &lt;li&gt;https://${jenkins-url}/OicLogout, https://${jenkins-url}/securityRealm/finishLogin&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Allowed OAuth Flows:
        &lt;ul&gt;
          &lt;li&gt;Authorization code grant&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Allowed OAuth Scopes:
        &lt;ul&gt;
          &lt;li&gt;email&lt;/li&gt;
          &lt;li&gt;openid&lt;/li&gt;
          &lt;li&gt;profile&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;jenkins-configuration&quot;&gt;Jenkins configuration&lt;/h2&gt;
&lt;ol&gt;
  &lt;li&gt;Go to “Manage Jenkins-&amp;gt;Plugins” and install the &lt;a href=&quot;https://plugins.jenkins.io/oic-auth/&quot;&gt;OpenId Connect Authentication&lt;/a&gt; plugin&lt;/li&gt;
  &lt;li&gt;Go to “Manage Jenkins-&amp;gt;Configure Global Security”&lt;/li&gt;
  &lt;li&gt;In the “Security Realm” section select “Login with Openid Connect”&lt;/li&gt;
  &lt;li&gt;Specify the “Client id” “Client secret” by using the values read in step #14 from the previous list&lt;/li&gt;
  &lt;li&gt;Select “Manual configuration”. You’ll need the value of the cognito domain that was created at step #13 in the cognito section. It should look like the following:
    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;https://jenkins-${company_name}-${some_random_string}.${aws_region}.amazoncognito.com
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
    &lt;p&gt;Specify the following values:&lt;/p&gt;
    &lt;ol&gt;
      &lt;li&gt;Token server url:
        &lt;ul&gt;
          &lt;li&gt;https://jenkins-${company_name}-${some_random_string}.${aws_region}.amazoncognito.com/oauth2/token&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Authorization server url:
        &lt;ul&gt;
          &lt;li&gt;https://jenkins-${company_name}-${some_random_string}.${aws_region}.amazoncognito.com/oauth2/authorize&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;UserInfo server url:
        &lt;ul&gt;
          &lt;li&gt;https://jenkins-${company_name}-${some_random_string}.${aws_region}.amazoncognito.com/oauth2/userInfo&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Scopes:
        &lt;ul&gt;
          &lt;li&gt;openid email profile&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Select “Logout from OpenID Provider”&lt;/li&gt;
      &lt;li&gt;End session URL for OpenID Provider:
        &lt;ul&gt;
          &lt;li&gt;https://jenkins-${company_name}-${some_random_string}.${aws_region}.amazoncognito.com/logout?client_id=${client_id}&amp;amp;logout_uri=https://${jenkins-url}&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
      &lt;li&gt;Click “Advanced button”
        &lt;ol&gt;
          &lt;li&gt;Specify “User name field name” = username&lt;/li&gt;
          &lt;li&gt;“Email field “name = email&lt;/li&gt;
        &lt;/ol&gt;
      &lt;/li&gt;
      &lt;li&gt;Scroll down a bit and find the “Configure ‘escape hatch’ for when the OpenID Provider is unavailable” checkbox.
        &lt;ol&gt;
          &lt;li&gt;Specify the username and passowrd to be used to access jenkins bypassing the cognito auth. To use the functionally goto ‘/login’ using the username and secret as username and password resp.&lt;/li&gt;
        &lt;/ol&gt;
      &lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Now you can add the user into the pool with the valid email and the phone number. Jenkins login page will regirect you to the cognito auth page.&lt;/p&gt;

&lt;p&gt;Source links:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-reference.html&quot;&gt;Amazon Cognito API References&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://plugins.jenkins.io/oic-auth/&quot;&gt;OpenId Connect Authentication&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://medium.com/@robert.broeckelmann/openid-connect-authorization-code-flow-with-aws-cognito-246997abd11a&quot;&gt;OpenID Connect Authorization Code Flow with AWS Cognito&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><author><name>admin</name></author><category term="Jenkins" /><category term="Cognito" /><summary type="html">Jenkins auth over AWS Cognito</summary></entry><entry><title type="html">Copy the Jenkins job</title><link href="/copy-jenkins-jobs/" rel="alternate" type="text/html" title="Copy the Jenkins job" /><published>2020-04-06T00:00:00+00:00</published><updated>2020-04-06T00:00:00+00:00</updated><id>/copy-jenkins-jobs</id><content type="html" xml:base="/copy-jenkins-jobs/">&lt;p&gt;Для начала вам нужно будет скопировать jenkins-cli.jar к себе на компьютер.
&lt;img src=&quot;assets/images/JenkinsCLIMenu.png&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Получаем список плагинов:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;java &lt;span class=&quot;nt&quot;&gt;-jar&lt;/span&gt; ~/Downloads/jenkins-cli.jar &lt;span class=&quot;nt&quot;&gt;-auth&lt;/span&gt; &amp;lt;username&amp;gt;:&amp;lt;password&amp;gt; &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; https://&amp;lt;jenkins_server_address&amp;gt;/ list-jobs
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Находим в списке имя билда, который нас интересует и получаем сведенья о нем:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;java &lt;span class=&quot;nt&quot;&gt;-jar&lt;/span&gt; ~/Downloads/jenkins-cli.jar &lt;span class=&quot;nt&quot;&gt;-auth&lt;/span&gt; &amp;lt;username&amp;gt;:&amp;lt;password&amp;gt; &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; https://&amp;lt;jenkins_server_address&amp;gt;/ get-job &lt;span class=&quot;s2&quot;&gt;&quot;Build name&quot;&lt;/span&gt; |pbcopy
pbpaste | java &lt;span class=&quot;nt&quot;&gt;-jar&lt;/span&gt; ~/Downloads/jenkins-cli.jar &lt;span class=&quot;nt&quot;&gt;-auth&lt;/span&gt; &amp;lt;username&amp;gt;:&amp;lt;password&amp;gt; &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; https://&amp;lt;jenkins_server_address&amp;gt;/ create-job &lt;span class=&quot;s2&quot;&gt;&quot;Build name&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>Yaroslav Yarmoshyk</name></author><category term="Jenkins" /><summary type="html">Copy the Jenkins job</summary></entry><entry><title type="html">Установка nginx из исходников</title><link href="/install-nginx-from-sources/" rel="alternate" type="text/html" title="Установка nginx из исходников" /><published>2019-09-30T20:40:15+00:00</published><updated>2019-09-30T20:40:15+00:00</updated><id>/install-nginx-from-sources</id><content type="html" xml:base="/install-nginx-from-sources/">&lt;p&gt;В разных случаях приходится компилировать ПО имея его исходники. Опять же хочу разводить демагогию на эту тему. Хочу рассказать как собрать nginx последней версии на CentOS v.6.3.&lt;/p&gt;

&lt;p&gt;Итак идем на &lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt; и скачиваем последнюю версию. (в моем случае это 1.9.9)&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget http://nginx.org/download/nginx-1.9.9.tar.gz
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Распаковываем архив:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;tar &lt;/span&gt;xf nginx-1.9.9.tar.gz &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;nginx-1.9.9
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Можно посмотреть справку по configure и включить только то, что нужно в нашу сборку:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;./configure &lt;span class=&quot;nt&quot;&gt;-help&lt;/span&gt; |less
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Между прочим, можно почитать требования к CMS системе, на которой написан сайт и включить только то, что для нее нужно.&lt;/p&gt;

&lt;p&gt;Для себя я выбрал вот такой вот набор опций:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nt&quot;&gt;-prefix&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/nginx - папка для установки  
&lt;span class=&quot;nt&quot;&gt;-user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;nginx - пользователь, под которым будет выполняться nginx  
&lt;span class=&quot;nt&quot;&gt;-group&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;nginx - группа  
&lt;span class=&quot;nt&quot;&gt;-with-http_ssl_module&lt;/span&gt; - включаем поддержку ssl  
&lt;span class=&quot;nt&quot;&gt;-with-http_spdy_module&lt;/span&gt; - включаем поддержку spdy  
&lt;span class=&quot;nt&quot;&gt;-with-http_realip_module&lt;/span&gt; - включаем поддержку realip  
&lt;span class=&quot;nt&quot;&gt;-with-http_geoip_module&lt;/span&gt; - включаем поддержку geoip  
&lt;span class=&quot;nt&quot;&gt;-with-http_gzip_static_module&lt;/span&gt; - включаем поддержку gzip для статического контента  
&lt;span class=&quot;nt&quot;&gt;-with-http_auth_request_module&lt;/span&gt; - включаем поддержку базовой авторизации  
&lt;span class=&quot;nt&quot;&gt;-with-http_perl_module&lt;/span&gt; - включаем поддержку perl  
&lt;span class=&quot;nt&quot;&gt;-http-log-path&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/var/log/nginx/access.log - путь к логу.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Добавляем пользователя (группа для него будет создана автоматически):&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;useradd &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; /etc/nginx nginx
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Создаем папку для логов:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mkdir /var/log/nginx/  
chown nginx:nginx /var/log/nginx/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Для такого набора мне нужно установить недостающие в системе библиотеки:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;yum install pcre-devel openssl-devel perl-ExtUtils-Embed
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Логика такая: выбираю dev пакеты, остальные - втягиваются, как зависимости&lt;/p&gt;

&lt;p&gt;В ходе сбора пакета мне выплюнуло вот такую вот ошибку:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;./configure: error: the GeoIP module requires the GeoIP library.  
You can either &lt;span class=&quot;k&quot;&gt;do &lt;/span&gt;not &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;the module or install the library.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Я так хочу, что бы &lt;code class=&quot;highlighter-rouge&quot;&gt;GeoIp&lt;/code&gt; был включен в сборку, придется его тоже ставить руками, поскольку yum его не нашел.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget http://www.maxmind.com/download/geoip/api/c/GeoIP-latest.tar.gz  
&lt;span class=&quot;nb&quot;&gt;tar &lt;/span&gt;xf GeoIP-latest.tar.gz &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;cd cd &lt;/span&gt;GeoIP-1.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;  
./configure  
make  
make install
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;В ход установки в консоле пробежало сообщение:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Libraries have been installed &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;:  
/usr/local/lib
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Подозреваю, что именно туда оно и было установлено. Сделаем симлинк на всякий случай. Боюсь, что nginx там не увидит нужную библиотеку:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ln &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; /usr/local/lib/libGeoIP.so.1.6.0 /usr/lib64/libGeoIP.so.1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;После этого nginx собирался без проблем:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;./configure &lt;span class=&quot;nt&quot;&gt;-prefix&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/etc/nginx &lt;span class=&quot;nt&quot;&gt;-user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;nginx &lt;span class=&quot;nt&quot;&gt;-group&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;nginx &lt;span class=&quot;nt&quot;&gt;-with-http_ssl_module&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-with-http_spdy_module&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-with-http_realip_module&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-with-http_geoip_module&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-with-http_gzip_static_module&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-with-http_auth_request_module&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-with-http_perl_module&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-http-log-path&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/var/log/nginx  
make  
make install
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;После долгих раздумий на виртуальной машине оно все таки скомпилировалось и установилось.&lt;/p&gt;

&lt;p&gt;После этого осталось сделать init скрипт для запуска. К сожалению в папке с исходниками его нету.&lt;br /&gt;
Его можно &lt;a href=&quot;/wp-content/uploads/2014/05/nginx&quot;&gt;скачать с моего сайта&lt;/a&gt;:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget &lt;span class=&quot;nt&quot;&gt;-O&lt;/span&gt; /etc/init.d/nginx /wp-content/uploads/2014/05/nginx  
chmod +x /etc/init.d/nginx
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Дальше запускаем:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;/etc/init.d/nginx start
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;и проверяем или он запущен:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;netstat &lt;span class=&quot;nt&quot;&gt;-nlp&lt;/span&gt; |grep nginx
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Радуемся.&lt;/p&gt;</content><author><name>admin</name></author><category term="nginx from sources" /><category term="установка nginx из исходного" /><summary type="html">В разных случаях приходится компилировать ПО имея его исходники. Опять же хочу разводить демагогию на эту тему. Хочу рассказать как собрать nginx последней версии на CentOS v.6.3.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/wp-content/uploads/2014/02/nginx1-660x378.gif" /></entry><entry><title type="html">Уникальные IP адреса в access.log Apache</title><link href="/unique-records-in-access-log-apache/" rel="alternate" type="text/html" title="Уникальные IP адреса в access.log Apache" /><published>2018-04-16T06:33:14+00:00</published><updated>2018-04-16T06:33:14+00:00</updated><id>/unique-records-in-access-log-apache</id><content type="html" xml:base="/unique-records-in-access-log-apache/">&lt;p&gt;Получить список уникальных IP адресов в лог файле вэбсервера &lt;code class=&quot;highlighter-rouge&quot;&gt;Apache&lt;/code&gt; можно с помощью:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;access.log | awk &lt;span class=&quot;s1&quot;&gt;'{print $1}'&lt;/span&gt; | sort &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; | uniq &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; | sort &lt;span class=&quot;nt&quot;&gt;-nr&lt;/span&gt; | head &lt;span class=&quot;nt&quot;&gt;-20&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Она же сработает и для логов вэбсервера &lt;code class=&quot;highlighter-rouge&quot;&gt;Nginx&lt;/code&gt;, носколько в обоих фарматах IP адрес посетителя является первым полем каждой записи.&lt;/p&gt;</content><author><name>admin</name></author><category term="Apache" /><category term="Nginx" /><category term="logfile" /><summary type="html">Получить список уникальных IP адресов в лог файле вэбсервера Apache можно с помощью:</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/wp-content/uploads/2014/04/2f6f31b946b74db396749c297545dee2.jpg" /></entry><entry><title type="html">Установка WireShark на Ubuntu 16.04/14.04</title><link href="/install-wireshark-ubuntu-16-0414-04/" rel="alternate" type="text/html" title="Установка WireShark на Ubuntu 16.04/14.04" /><published>2017-03-10T10:36:00+00:00</published><updated>2017-03-10T10:36:00+00:00</updated><id>/install-wireshark-ubuntu-16-0414-04</id><content type="html" xml:base="/install-wireshark-ubuntu-16-0414-04/">&lt;p&gt;WireShark предоставляет удобный функционал для анализа сетевого трафика.&lt;/p&gt;

&lt;p&gt;Для Linux он доступен в виде пакета с исходным кодом, который можно скачать по следующей ссылке:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://1.na.dl.wireshark.org/src/wireshark-2.2.5.tar.bz2&quot;&gt;https://1.na.dl.wireshark.org/src/wireshark-2.2.5.tar.bz2&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;На много удобнее устанавливать уже готовый пакет. Для этого достаточно выполнить всего 2 шага:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;add-apt-repository ppa:wireshark-dev/stable
apt-get update
apt-get install wireshark
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>admin</name></author><category term="WireShark Ubuntu" /><summary type="html">WireShark предоставляет удобный функционал для анализа сетевого трафика.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/wp-content/uploads/2017/03/wireshark-icon2.png" /></entry><entry><title type="html">Проблемы с ttf-mscorefonts-installer на Ubuntu 16.04</title><link href="/ttf-mscorefonts-installer-ubuntu-16-04/" rel="alternate" type="text/html" title="Проблемы с ttf-mscorefonts-installer на Ubuntu 16.04" /><published>2017-01-13T00:58:33+00:00</published><updated>2017-01-13T00:58:33+00:00</updated><id>/ttf-mscorefonts-installer-ubuntu-16-04</id><content type="html" xml:base="/ttf-mscorefonts-installer-ubuntu-16-04/">&lt;p&gt;Сегодня меня в конец достало назойливое уведомление о том, что &lt;code class=&quot;highlighter-rouge&quot;&gt;ttf-mscorefonts-installer&lt;/code&gt; не смог установить все, что ему нужно.&lt;/p&gt;

&lt;p&gt;Это окошко появлялось несколько раз за день&lt;br /&gt;
&lt;img src=&quot;/wp-content/uploads/2016/12/Screenshot-from-2016-12-12-00-46-18.png&quot; alt=&quot;screenshot-from-2016-12-12-00-46-18&quot; width=&quot;549&quot; height=&quot;439&quot; class=&quot;aligncenter size-full wp-image-3577&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Каждый раз, когда я кликал кнопку &lt;code class=&quot;highlighter-rouge&quot;&gt;Run this action now&lt;/code&gt; ничего хорошего не происходило. Утилита пыталась скачать установщики шрифтов с &lt;code class=&quot;highlighter-rouge&quot;&gt;downloads.sourceforge.net&lt;/code&gt; и каждый раз терпела неудачу.&lt;/p&gt;

&lt;p&gt;Попытки переутановить &lt;code class=&quot;highlighter-rouge&quot;&gt;ttf-mscorefonts-installer&lt;/code&gt; разбивались о все те же скалы:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt-get install &lt;span class=&quot;nt&quot;&gt;--reinstall&lt;/span&gt; ttf-mscorefonts-installer
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;В консольном выводе я получал вот такую ошибку:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Err:1 http://downloads.sourceforge.net/corefonts/andale32.exe
  404  Not Found
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Или вот такую:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Protocol &lt;span class=&quot;s2&quot;&gt;&quot;http&quot;&lt;/span&gt; not supported or disabled &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;libcurl
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Все ссылки, на скачиваеи файлов установки шрифтов, хранятся в следующем файле:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;/usr/share/package-data-downloads/ttf-mscorefonts-installer&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Оказывается &lt;code class=&quot;highlighter-rouge&quot;&gt;curl&lt;/code&gt; умирает по таймауту, пока &lt;a href=&quot;http://sourceforge.net&quot;&gt;sourceforge.net&lt;/a&gt; ищет живое зеркало с которого можно было бы скачать файл. Если поменять http на https и прописать живое зеркало в файл-список, то установка срабатывает на ура:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;http://downloads.sourceforge.net/corefonts/&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;  
&lt;span class=&quot;nv&quot;&gt;rep&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;https://netcologne.dl.sourceforge.net/project/corefonts/the%20fonts/final/&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;  
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;sed &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt; &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;s#&lt;span class=&quot;nv&quot;&gt;$src&lt;/span&gt;&lt;span class=&quot;c&quot;&gt;#$rep#g` /usr/share/package-data-downloads/ttf-mscorefonts-installer&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Как определить рабочее зеркало? — В консоли выполняем:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget http://downloads.sourceforge.net/project/corefonts/the%20fonts/final/andale32.exe?r&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&amp;amp;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ts&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1483087183&lt;span class=&quot;se&quot;&gt;\&amp;amp;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;use_mirror&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;netcologne
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;В результате получаем следующий вывод (подсвечено рабочее зеркало):&lt;br /&gt;
&lt;img src=&quot;/wp-content/uploads/2016/12/Screenshot-from-2016-12-30-00-42-50.png&quot; alt=&quot;screenshot-from-2016-12-30-00-42-50&quot; width=&quot;956&quot; height=&quot;189&quot; class=&quot;aligncenter size-full wp-image-3614&quot; /&gt;&lt;/p&gt;

&lt;p&gt;После этого выполняем одну из следующих команд:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo&lt;/span&gt; /usr/lib/update-notifier/package-data-downloader
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;или&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt-get install &lt;span class=&quot;nt&quot;&gt;-reinstall&lt;/span&gt; ttf-mscorefonts-installer
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;В случае успешного выполнения вы получите следующий вывод по каждому из шрифтов:&lt;br /&gt;
&lt;img src=&quot;/wp-content/uploads/2016/12/Screenshot-from-2016-12-12-00-48-00.png&quot; alt=&quot;screenshot-from-2016-12-12-00-48-00&quot; width=&quot;318&quot; height=&quot;122&quot; class=&quot;aligncenter size-full wp-image-3576&quot; /&gt;&lt;/p&gt;</content><author><name>admin</name></author><category term="ttf-mscorefonts-installer" /><summary type="html">Сегодня меня в конец достало назойливое уведомление о том, что ttf-mscorefonts-installer не смог установить все, что ему нужно.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/wp-content/uploads/2014/07/ubuntu_circle.png" /></entry><entry><title type="html">Настройка отказоустойчивого кластера для RabbitMQ</title><link href="/configure-rabbitmq-cluster/" rel="alternate" type="text/html" title="Настройка отказоустойчивого кластера для RabbitMQ" /><published>2016-12-29T16:55:34+00:00</published><updated>2016-12-29T16:55:34+00:00</updated><id>/configure-rabbitmq-cluster</id><content type="html" xml:base="/configure-rabbitmq-cluster/">&lt;p&gt;RabbitMQ представляет собой универсальный способ обмена сообщениями между предложениями. Если Вы попали на эту страницу, значит Вы уже знаете что такое RabbitMQ, поэтому я не буду вдаваться в полемику.&lt;/p&gt;

&lt;p&gt;Эта статья описывает настройку кластера RabbitMQ на базе серверов Linux CentOS v.7. Фишка кластера в том, что в нем нету понятия глобального мастера. Роль мастера отводится какому-либо серверу только в рамках одного события в очереди сообщений. Отключение одного сервера не валит всю систему, а после возвращения его в строй Вам не нужно думать о синхронизации данных - RabbitMQ сделает это сам.&lt;/p&gt;

&lt;p&gt;Итак по порядку. На каждом сервере в кластере выполняем следующие шаги:&lt;/p&gt;

&lt;p&gt;Включаем EPEL&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;rpm &lt;span class=&quot;nt&quot;&gt;-ivh&lt;/span&gt; http://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-8.noarch.rpm
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Устанавливаем нужные библиотеки:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;yum install &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; vim net-tools wget git zip unip openssh-server openssh logrotate socat
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;RabbitMQ требует &lt;code class=&quot;highlighter-rouge&quot;&gt;Erlang&lt;/code&gt;. Есть 3 варианта&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Установить Eplang какой есть в Epel - у меня с этой версией сыпались ошибки при исключении сервера из кластера&lt;/li&gt;
  &lt;li&gt;Скачать и установить последнюю версию Erlang с сайта разработчиков - RabbitMQ вообще не смог установиться используя этот пакет&lt;/li&gt;
  &lt;li&gt;Собрать Erlang, который оптимизирован под Rabbit и включает только нужные RabbitMQ компоненты - долгий путь, но именно он и является самым надежным&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Создаем &lt;code class=&quot;highlighter-rouge&quot;&gt;rpm&lt;/code&gt; пакет &lt;code class=&quot;highlighter-rouge&quot;&gt;Erlang&lt;/code&gt;. Для этого Вам понадобится &lt;code class=&quot;highlighter-rouge&quot;&gt;Docker&lt;/code&gt;. Его можно установить на сервер выполнять все удаленно. Второй вариант - установить &lt;code class=&quot;highlighter-rouge&quot;&gt;Docker&lt;/code&gt; локально (на компьютер с Linux), собрать пакет и залить его потом на сервер. Естественно нету смысла собирать RPM пакет на каждом сервере отдельно. Будет эффективнее создать его один раз и скопировать на все сервера в кластере.&lt;/p&gt;

&lt;p&gt;Клонируем репозиторий&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git clone https://github.com/rabbitmq/erlang-rpm.git  
сd erlang-rpm/docker/  
sed &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'s/-i\ -t/-tty/g'&lt;/span&gt; build-rpm-in-docker.sh  
bash build-image-and-rpm.sh latest
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;По окончанию выполнения скрипта rpm файлы будут лежать в папке:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;build-dir-latest/RPMS/x86_64/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Можно устанавливать &lt;code class=&quot;highlighter-rouge&quot;&gt;Erlang&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;yum install &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; build-dir-latest/RPMS/x86_64/erlang-19.2.0-1.el7.centos.x86_64.rpm  
yum install &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; build-dir-latest/RPMS/x86_64/erlang-debuginfo-19.2.0-1.el7.centos.x86_64.rpm
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Последняя версия &lt;code class=&quot;highlighter-rouge&quot;&gt;RabbitMQ&lt;/code&gt; на сегодняшний день это v.3.6.6.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget &lt;span class=&quot;nt&quot;&gt;-O&lt;/span&gt; /tmp/rabbitmq-server-3.6.6-1.el7.noarch.rpm https://www.rabbitmq.com/releases/rabbitmq-server/v3.6.6/rabbitmq-server-3.6.6-1.el7.noarch.rpm &lt;span class=&quot;nt&quot;&gt;-no-check-certificate&lt;/span&gt;  
rpm &lt;span class=&quot;nt&quot;&gt;-import&lt;/span&gt; http://www.rabbitmq.com/rabbitmq-release-signing-key.asc  
yum install &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; /tmp/rabbitmq-server-3.6.6-1.el7.noarch.rpm
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;center&gt;
  &lt;div id=&quot;gads&quot;&gt;
  &lt;/div&gt;
&lt;/center&gt;

&lt;p&gt;У RabbitMQ есть web интерфейс и WebAPI, которое очень полезно в ежедневном использовании. По умолчанию оно выключено. Включается плагином:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;rabbitmq-plugins &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;rabbitmq_management
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Вам будет предложено перезапустить RabbitMQ. После этого WEB интерфейс будет доступен на 15672-м порту.:&lt;br /&gt;
http://ip_адрес_сервера:15672/&lt;/p&gt;

&lt;p&gt;Стандартный пользователь:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;логин: guest&lt;/li&gt;
  &lt;li&gt;пароль: guest&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;На первой-же странице Вы увидите состояние кластера. (пока только один сервер)&lt;/p&gt;

&lt;p&gt;Для получения сведений из консоли - выполните:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;rabbitmqctl cluster_status
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;В результате Вы получите что-то в стиле:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;root@cd27271cd9ff /]# rabbitmqctl cluster_status
Cluster status of node rabbit@cd27271cd9ff ...
&lt;span class=&quot;o&quot;&gt;[{&lt;/span&gt;nodes,[&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;disc,[rabbit@cd27271cd9ff]&lt;span class=&quot;o&quot;&gt;}]}&lt;/span&gt;,
 &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;running_nodes,[rabbit@cd27271cd9ff]&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
 &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;cluster_name,&amp;lt;&amp;lt;&lt;span class=&quot;s2&quot;&gt;&quot;rabbit@cd27271cd9ff&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;}&lt;/span&gt;,
 &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;partitions,[]&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
 &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;alarms,[&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;rabbit@cd27271cd9ff,[]&lt;span class=&quot;o&quot;&gt;}]}]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;До этого момента Вы видите только один сервер. Осталось объединить все Ваши сервера в один кластер. Для этого Вам понадобится 2 вещи:&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;Значение Erlang cookie - оно должно быть одинаковым на всех серверах. Его можно получить из следущего файла:
    &lt;ul&gt;
      &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;/var/lib/rabbitmq/.erlang.cookie&lt;/code&gt;
Этот файл должен быть одинаковым на всех серверах, принадлежать пользователю rabbitmq и иметь права доступа 600.&lt;br /&gt;
После изменения файла нужно перезапустить демон rabbitmq&amp;lt;/li&amp;gt;&lt;/li&gt;
      &lt;li&gt;Имя сервера, который будет считаться первым в кластере (не мастером, а просто первым в кластере)&amp;lt;/ol&amp;gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;Дальше выберите один из серверов (первый в вашем списке) в результатах вывода &lt;code class=&quot;highlighter-rouge&quot;&gt;cluster_status&lt;/code&gt;. В этом примере - &lt;code class=&quot;highlighter-rouge&quot;&gt;rabbit@cd27271cd9ff&lt;/code&gt;. Копируем в буфер обмена с первого сервера и выполняем следующее на всех остальных серверах:
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;rabbitmqctl stop_app  
rabbitmqctl reset  
rabbitmqctl join_cluster rabbit@cd27271cd9ff
rabbitmqctl start_app
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
    &lt;p&gt;После этого вывод &lt;code class=&quot;highlighter-rouge&quot;&gt;cluster_status&lt;/code&gt; и WEB интерфейс на любом из серверов кластера будут содержать имена всех серверов.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Для распределения запросов между серверами можно &lt;a href=&quot;http://haproxy.tech-notes.net/use-ha-proxy-rabbitmq/&quot;&gt;воспользоваться HA-Proxy&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;На этом серверная часть настройки закончена. Ниэже я привожу пример того, как можно создать хосты, пользователей и очереди сообщений. Эти действия можно выполнять на одном сервере.&lt;/p&gt;

&lt;p&gt;Поскольку все команды выполняются в bash, рекомендую объявить несколько переменных, которые будут повторяться в дальнейших командах&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;имя_пользователя&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;  
&lt;span class=&quot;nv&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;пароль_пользователя&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;  
&lt;span class=&quot;nv&quot;&gt;vhost&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;имя_виртуального_хоста&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;  
&lt;span class=&quot;nv&quot;&gt;queue_name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;название_очереди_сообщений&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;  
&lt;span class=&quot;nv&quot;&gt;exchange&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;имя_для_обменника&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Создаем виртуальны хост:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;rabbitmqadmin &lt;span class=&quot;nb&quot;&gt;declare &lt;/span&gt;vhost &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;vhost&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Создаем пользователя для доступа к хосту:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;rabbitmqadmin &lt;span class=&quot;nb&quot;&gt;declare &lt;/span&gt;user &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;tags&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;administrator  
rabbitmqadmin &lt;span class=&quot;nb&quot;&gt;declare &lt;/span&gt;permission &lt;span class=&quot;nv&quot;&gt;vhost&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;vhost&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;configure&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;se&quot;&gt;\*&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;se&quot;&gt;\*&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Создаем буфер обмена:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;rabbitmqadmin &lt;span class=&quot;nt&quot;&gt;-V&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;vhost&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;declare &lt;/span&gt;exchange &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;exchange&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;fanout
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Создаем очередь сообщений:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;rabbitmqadmin &lt;span class=&quot;nt&quot;&gt;-V&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;vhost&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;declare &lt;/span&gt;queue &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;queue_name&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;durable&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Связываем буфер обмена с очередью сообщений:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;rabbitmqadmin &lt;span class=&quot;nt&quot;&gt;-V&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;vhost&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;declare &lt;/span&gt;binding &lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;exchange&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;destination_type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;queue &lt;span class=&quot;nv&quot;&gt;destination&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;queue_name&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Определяем HA (high availability) политики для кластера:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;rabbitmqadmin &lt;span class=&quot;nt&quot;&gt;-V&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;vhost&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;declare &lt;/span&gt;policy &lt;span class=&quot;nv&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;ha_all &lt;span class=&quot;nv&quot;&gt;pattern&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;definition&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'{`ha-mode`:`all`,`ha-sync-mode`:`automatic`}'&lt;/span&gt; apply-to&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;all
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Полезные ресурсы:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.rabbitmq.com/man/rabbitmqctl.1.man.html&quot;&gt;Инструкция к rabbitmqctl&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://raw.githack.com/rabbitmq/rabbitmq-management/rabbitmq_v3_6_6/priv/www/api/index.html&quot;&gt;Инструкция к WEB api&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://haproxy.tech-notes.net/use-ha-proxy-rabbitmq/&quot;&gt;Использование Ha-Proxy для RabbitMQ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><author><name>admin</name></author><category term="RabbitMQ" /><summary type="html">RabbitMQ представляет собой универсальный способ обмена сообщениями между предложениями. Если Вы попали на эту страницу, значит Вы уже знаете что такое RabbitMQ, поэтому я не буду вдаваться в полемику.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/wp-content/uploads/2016/12/rabbitmq-logo.png" /></entry><entry><title type="html">Ошибка `not a TTY` при выполнении `docker exec`</title><link href="/not-a-tty-docker-exec/" rel="alternate" type="text/html" title="Ошибка `not a TTY` при выполнении `docker exec`" /><published>2016-11-29T10:41:10+00:00</published><updated>2016-11-29T10:41:10+00:00</updated><id>/not-a-tty-docker-exec</id><content type="html" xml:base="/not-a-tty-docker-exec/">&lt;p&gt;Я упущу предысторию как я столкнулся с этой проблемой, но самого факта это не меняет.&lt;/p&gt;

&lt;p&gt;Один из &lt;code class=&quot;highlighter-rouge&quot;&gt;ansible&lt;/code&gt; playbook’ов, который недавно попал ко мне на ревизию, содержал несколько шагов, в которых с помощью &lt;code class=&quot;highlighter-rouge&quot;&gt;shell&lt;/code&gt; модуля выполнялись операции в докер контейнерах с помощью &lt;code class=&quot;highlighter-rouge&quot;&gt;docker exec&lt;/code&gt;. После обновления до последнего &lt;code class=&quot;highlighter-rouge&quot;&gt;docker&lt;/code&gt; и &lt;code class=&quot;highlighter-rouge&quot;&gt;ansible&lt;/code&gt; начали сыпаться следующие ошибки при выполнении этого playbook’а:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;fatal: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;servername.network]: FAILED! &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;changed&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;cmd&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;docker&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;exec&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;-it&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;somecommand here to run in docker container&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;,
&lt;span class=&quot;s2&quot;&gt;&quot;delta&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;0:00:00.019926&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;end&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2016-11-29 02:01:31.597629&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;failed&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;rc&quot;&lt;/span&gt;: 1,
&lt;span class=&quot;s2&quot;&gt;&quot;start&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;2016-11-29 02:01:31.577703&quot;&lt;/span&gt;,
&lt;span class=&quot;s2&quot;&gt;&quot;stderr&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;the input device is not a TTY&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;stdout&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;&quot;&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;stdout_lines&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[]&lt;/span&gt;, &lt;span class=&quot;s2&quot;&gt;&quot;warnings&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[]}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Решение проблемы оказалось тривиально простым - нужно все &lt;code class=&quot;highlighter-rouge&quot;&gt;docker exec -it&lt;/code&gt; поменять на &lt;code class=&quot;highlighter-rouge&quot;&gt;docker exec --tty&lt;/code&gt;. После таких правок &lt;code class=&quot;highlighter-rouge&quot;&gt;playbook&lt;/code&gt; сработал на ура.&lt;/p&gt;

&lt;p&gt;Осталось переписать его на использование &lt;code class=&quot;highlighter-rouge&quot;&gt;docker+command&lt;/code&gt;, но это уже другая история.&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/mitchellh/vagrant/issues/7597&quot; target=&quot;_blank&quot;&gt;https://github.com/mitchellh/vagrant/issues/7597&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><author><name>admin</name></author><summary type="html">Я упущу предысторию как я столкнулся с этой проблемой, но самого факта это не меняет.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/wp-content/uploads/2016/11/good-luck-docker-chan.png" /></entry><entry><title type="html">Проблема с авторизацией Vagrant при выполнении kitchen create в Chef</title><link href="/vagrant-kitchen-create-chef/" rel="alternate" type="text/html" title="Проблема с авторизацией Vagrant при выполнении kitchen create в Chef" /><published>2016-11-29T05:30:26+00:00</published><updated>2016-11-29T05:30:26+00:00</updated><id>/vagrant-kitchen-create-chef</id><content type="html" xml:base="/vagrant-kitchen-create-chef/">&lt;p&gt;Выполняя команду &lt;code class=&quot;highlighter-rouge&quot;&gt;kitchen create&lt;/code&gt; при тестировании поваренной книги в Chef можно получить следующую ошибку при работе с Vagrant 1.8.5:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;default: Warning: Authentication failure. Retrying...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Полный текст ошибки следующий:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kitchen create
&lt;span class=&quot;nt&quot;&gt;-----&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; Starting Kitchen &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;v1.11.1&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;-----&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; Creating ...
       Bringing machine &lt;span class=&quot;s1&quot;&gt;'default'&lt;/span&gt; up with &lt;span class=&quot;s1&quot;&gt;'virtualbox'&lt;/span&gt; provider...
       &lt;span class=&quot;o&quot;&gt;==&amp;gt;&lt;/span&gt; default: Checking &lt;span class=&quot;k&quot;&gt;if &lt;/span&gt;box &lt;span class=&quot;s1&quot;&gt;'bento/centos-7.2'&lt;/span&gt; is up to date...
       &lt;span class=&quot;o&quot;&gt;==&amp;gt;&lt;/span&gt; default: Clearing any previously &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;forwarded ports...
       &lt;span class=&quot;o&quot;&gt;==&amp;gt;&lt;/span&gt; default: Clearing any previously &lt;span class=&quot;nb&quot;&gt;set &lt;/span&gt;network interfaces...
       &lt;span class=&quot;o&quot;&gt;==&amp;gt;&lt;/span&gt; default: Preparing network interfaces based on configuration...
           default: Adapter 1: nat
       &lt;span class=&quot;o&quot;&gt;==&amp;gt;&lt;/span&gt; default: Forwarding ports...
           default: 22 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;guest&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; 2222 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;host&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;adapter 1&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
       &lt;span class=&quot;o&quot;&gt;==&amp;gt;&lt;/span&gt; default: Running &lt;span class=&quot;s1&quot;&gt;'pre-boot'&lt;/span&gt; VM customizations...
       &lt;span class=&quot;o&quot;&gt;==&amp;gt;&lt;/span&gt; default: Booting VM...
       &lt;span class=&quot;o&quot;&gt;==&amp;gt;&lt;/span&gt; default: Waiting &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;machine to boot. This may take a few minutes...
           default: SSH address: 127.0.0.1:2222
           default: SSH username: vagrant
           default: SSH auth method: private key
           default: Warning: Remote connection disconnect. Retrying...
           default: Warning: Authentication failure. Retrying...
           default: Warning: Authentication failure. Retrying...
           default: Warning: Authentication failure. Retrying...
           default: Warning: Authentication failure. Retrying...
           default: Warning: Authentication failure. Retrying...
           default: Warning: Authentication failure. Retrying...
           default: Warning: Authentication failure. Retrying...
           default: Warning: Authentication failure. Retrying...
           default: Warning: Authentication failure. Retrying...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Оказывается файл &lt;code class=&quot;highlighter-rouge&quot;&gt;authorized_keys&lt;/code&gt; имеет неправильные права доступа в тестовой среде &lt;code class=&quot;highlighter-rouge&quot;&gt;vagrant&lt;/code&gt;. Для временного решения нужно залогиниться в виртуальную машину используя консоль в интерфейсе virtualbox со следующими деталями:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;логин: vagrant&lt;/li&gt;
  &lt;li&gt;пароль: vagrant&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&quot;/wp-content/uploads/2016/11/kitchen-console-open.png&quot; alt=&quot;kitchen-console-open&quot; width=&quot;769&quot; height=&quot;603&quot; class=&quot;aligncenter size-full wp-image-3562&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Далее нужно выполнить следующую команду:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;chmod 644 /home/vagrant/.ssh/authorized_keys
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Такое решение не совсем подходит, так как Вам придется выполнять лишние шаги при создании новых тестовых машин. Я бы рекомендовал установить предыдущую версию Vagrant (v.1.8.4).&lt;/p&gt;

&lt;p&gt;Согласно обсуждению на по следующей ссылке, разработчики знают об этой проблемы и планируют устранить ее в следующих релизах Vagrant:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/mitchellh/vagrant/issues/7627&quot;&gt;https://github.com/mitchellh/vagrant/issues/7627&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Архив релизов Vagrant доступен по следующей ссылке:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://releases.hashicorp.com/vagrant/1.8.4/&quot;&gt;https://releases.hashicorp.com/vagrant/1.8.4/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><author><name>admin</name></author><summary type="html">Выполняя команду kitchen create при тестировании поваренной книги в Chef можно получить следующую ошибку при работе с Vagrant 1.8.5:</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/wp-content/uploads/2016/11/using-vagrant-and-chef.png" /></entry><entry><title type="html">Как выставить umask для файлов в одной только папке</title><link href="/umask-per-folder-with-acl/" rel="alternate" type="text/html" title="Как выставить umask для файлов в одной только папке" /><published>2016-11-29T05:04:27+00:00</published><updated>2016-11-29T05:04:27+00:00</updated><id>/umask-per-folder-with-acl</id><content type="html" xml:base="/umask-per-folder-with-acl/">&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;Umask&lt;/code&gt; в Linux - это шаблон прав доступа для создаваемых файлов. Как правило указывается глобально в файле &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/profile&lt;/code&gt; или для каждого пользователя в файлах &lt;code class=&quot;highlighter-rouge&quot;&gt;.bashrc&lt;/code&gt; в домашнем каталоге.&lt;/p&gt;

&lt;p&gt;Но что же делать, если umask выставлен 022 (файлы создаются с правами &lt;code class=&quot;highlighter-rouge&quot;&gt;rw-r-r (0644)&lt;/code&gt;, а папки создаются с &lt;code class=&quot;highlighter-rouge&quot;&gt;rwx-rx-rx (0755)&lt;/code&gt;), но в одной конкретной папке нужно чтобы файлы были доступны для чтения и записи всем (&lt;code class=&quot;highlighter-rouge&quot;&gt;rw-rw-rw (666)&lt;/code&gt;)?&lt;/p&gt;

&lt;p&gt;В этом случае можно воспользоваться утилитой setfacl. Изменить ACL для существующих файлов можно с помощью следующей команды:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;setfacl &lt;span class=&quot;nt&quot;&gt;-R&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; u::rwx &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; g::rwx &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; o::rwx &lt;span class=&quot;k&quot;&gt;**&lt;/span&gt;имя_папки&lt;span class=&quot;k&quot;&gt;**&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;После выполнения следующей команды, все файлы в папке созданные в папке, имя которой Вы укажете, будут доступны всем пользователям системы для записи:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;setfacl &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; default:u::rwx &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; default:g::rw &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; default:o::rw &lt;span class=&quot;k&quot;&gt;**&lt;/span&gt;имя_папки&lt;span class=&quot;k&quot;&gt;**&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>admin</name></author><category term="acl" /><category term="umask" /><summary type="html">Umask в Linux - это шаблон прав доступа для создаваемых файлов. Как правило указывается глобально в файле /etc/profile или для каждого пользователя в файлах .bashrc в домашнем каталоге.</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="/wp-content/uploads/2014/01/5602646-check-mark-computer-generated-illustration-for-disign.jpg" /></entry></feed>