---
id: 2480
title: 'Размышления о кластеризации: Часть 4 - Нужно больше WEB&#8217;a'
date: 2015-03-20T15:20:00+00:00
author: admin

guid: http://www.tech-notes.net/?p=2480
permalink: /notes-about-clusters-part4/
image: /wp-content/uploads/2014/08/cluster_logo.jpg
categories:
  - Clusters
tags:
  - горизонтальное скалирование кластера
---
После продолжительного затишья решил продолжить повествование о разветвлении серверной линейки. Фраза получилась невнятной. По ходу дела она обретет смысл.

В предыдущих статьях о рассмотрел варианты конфигурации отдельных серевров для баз данных, сервера для раздичи статики и сервера для кеширования.

Предыдущие статьи:  
[Размышления о кластеризации: Часть 1](http://www.tech-notes.net/notes-about-clusters/ "Размышления о кластеризации. Часть 1")  
[Размышления о кластеризации: Часть 2](http://www.tech-notes.net/notes-about-clusters-part2/ "Размышления о кластеризации: Часть 2")  
[Размышления о кластеризации: Часть 3](http://www.tech-notes.net/notes-about-clusters-part3-varnish/ "Размышления о кластеризации: Часть 3")

Дальше речь пойдет о увеличени количества серверов, обслуживающих динамический контент.

Во [второй сатье](http://www.tech-notes.net/notes-about-clusters-part2/ "Размышления о кластеризации: Часть 2") я рекомендовал перенести весь контент на App сервер, [установить на нем NFS сервер](http://www.tech-notes.net/configure-nfs-server-and-client-centos/ "Настройка NFS сервера и его клиентов на базе CentOS") и замонтировать папку всего сайта на Web сервер. В рамках текущей статьи это уже не рекомендаци, а требование.

В таком случае у нас получается центральное хранилище контента, к которому можно обращаться с нескольких источников. Слабым местом будет пропускная способность сети между серверами, но в рамках одного датацентра она в несколько раз превышает скорость обмена данными между клиентами и самими серверами. Естественно лучше использовать <a href="http://en.wikipedia.org/wiki/Network-attached_storage" target="_blank">NAS</a>, но не все хостеры его предоставляют на приемлимых условиях, да и в большенстве случаев NAS нельзя подключить к виртуальным (cloud) серверам.

Возвращаемся с следующей схеме:  
[<img src="/wp-content/uploads/2014/08/Screenshot-from-2014-09-26-092414.png" alt="Screenshot from 2014-09-26 09:24:14" width="603" height="510" class="aligncenter size-full wp-image-1821" srcset="/wp-content/uploads/2014/08/Screenshot-from-2014-09-26-092414.png 603w, /wp-content/uploads/2014/08/Screenshot-from-2014-09-26-092414-170x143.png 170w, /wp-content/uploads/2014/08/Screenshot-from-2014-09-26-092414-300x253.png 300w" sizes="(max-width: 603px) 100vw, 603px" />](/wp-content/uploads/2014/08/Screenshot-from-2014-09-26-092414.png)

Вторым тебованием является балансировщик нагрузки. Большенство хостинг провайдэров предоставляют готовые решения. В те времена, когда трамваи не ходили и бородатые админы били бубном мамонтов, приходилось изощряться и использовать другие решения. Дальше по функциональности/популярности:

  1. <a href="http://www.tech-notes.net/haproxy-configuration-examples/" title="Примеры настройки HaProxy" target="_blank">Настройка HaProxy для балансировки нагрузки</a>
  2. <a href="http://www.tech-notes.net/load-balancing-nginx/" title="Балансировка нагрузки с помощью NginX" target="_blank">Балансировка нагрузки с помощью NginX</a>
  3. <a href="http://www.tech-notes.net/load-balancing-with-apache/" title="Балансировка нагрузки с помощью Apache" target="_blank">Балансировка нагрузки с помощью Apache</a>
  4. <a href="http://www.tech-notes.net/varnish-configuration-rewiev/" title="Обзор конфигурации Varnish" target="_blank">Varnish так же можно использовать для балансировки нагрузки</a>

Теперь, когда у Вас есть балансировщик нагрузки и файлохранилище, можно создавать еще одну web-голову:  
[<img src="/wp-content/uploads/2015/03/Screenshot-from-2015-03-20-102838.png" alt="Screenshot from 2015-03-20 10:28:38" width="414" height="574" class="aligncenter size-full wp-image-2482" srcset="/wp-content/uploads/2015/03/Screenshot-from-2015-03-20-102838.png 414w, /wp-content/uploads/2015/03/Screenshot-from-2015-03-20-102838-123x170.png 123w, /wp-content/uploads/2015/03/Screenshot-from-2015-03-20-102838-216x300.png 216w" sizes="(max-width: 414px) 100vw, 414px" />](/wp-content/uploads/2015/03/Screenshot-from-2015-03-20-102838.png)

И даже 2 или 3:  
[<img src="/wp-content/uploads/2015/03/Screenshot-from-2015-03-20-103711.png" alt="Screenshot from 2015-03-20 10:37:11" width="677" height="579" class="aligncenter size-full wp-image-2483" srcset="/wp-content/uploads/2015/03/Screenshot-from-2015-03-20-103711.png 677w, /wp-content/uploads/2015/03/Screenshot-from-2015-03-20-103711-170x145.png 170w, /wp-content/uploads/2015/03/Screenshot-from-2015-03-20-103711-300x257.png 300w" sizes="(max-width: 677px) 100vw, 677px" />](/wp-content/uploads/2015/03/Screenshot-from-2015-03-20-103711.png)

Мение популярным методом доставки трафика является DNS балансировка. Сразу оговорюсь, что этот метод не подходит всем. Суть подхода заключется в том, что для каждой web головы Вы создаете отдельную А запись в DNS зоне и Ваш сайт начинает резолвиться с несколькими ip адресами. Вроде бы круто, да? Загвоздка заключается в том, что если один из серверов будет выключен, то часть вэб клиентов будут видеть ошибку, которая говорит, что сайт недоступен. Дело в том, что DNS сервера не проверяют жив ли сайт на том ip адресе, который вписан в зону.

Использовать трюк с DNS балансировкой можно в том случае, если Ваш хостинг провайдер не привязывает железно публичный ip адрес к каждому серверу, а позволяет Вам поднимать виртуальные сетевые интерфейсы и присваивать им ip адреса других серверов из выделенной Вам подсети, тем самым `перебрасывать` ip адреса между серверами.

В таком случае можно <a href="http://www.tech-notes.net/configure-heartbeat-centos/" title="Настройка High Availability кластера с помощью Heartbeat на Centos" target="_blank">возпользоваться функционалом HeartBeet</a> и настроить все сервера таким образом, что бы они подмимали виртуальные сетевые адаптеры с недоступными ip адресами.

[<img src="/wp-content/uploads/2015/03/Screenshot-from-2015-03-20-105639.png" alt="Screenshot from 2015-03-20 10:56:39" width="673" height="543" class="aligncenter size-full wp-image-2487" srcset="/wp-content/uploads/2015/03/Screenshot-from-2015-03-20-105639.png 673w, /wp-content/uploads/2015/03/Screenshot-from-2015-03-20-105639-170x137.png 170w, /wp-content/uploads/2015/03/Screenshot-from-2015-03-20-105639-300x242.png 300w" sizes="(max-width: 673px) 100vw, 673px" />](/wp-content/uploads/2015/03/Screenshot-from-2015-03-20-105639.png)

И первый и второй метод имеют свои преимущества и недостатки. К недостаткам использования балансировщика нагрузки относится то, что он является дополнительным звеном цепи, что влияет на скорость ответа от сайта. Но если Вы захотите автоматизировать горизонтальное скалирование кластера, то столкнетесь с проблемой автоматического создания ДНС записей, если вы не имеете единой точки входа такой, как балансировщик нагрузки. Конечно некоторые хостеры имеют API, которое позволяет создавать записи на их серверах доменных имен (nameservers) с помощью простого POST запроса (<a href="http://docs.rackspace.com/cdns/api/v1.0/cdns-getting-started/content/Add_Records.html" target="_blank">RackSpace</a>), но ни у одного из популярных регистраторов доменных имен такого функционала нету.

Для отказоустойчивости очень хорошо комбинировать эти медоты. Тоесть имея 2 балансировщика нагрузки &#8230; дальше сами поняли 🙂
