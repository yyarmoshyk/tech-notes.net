---
id: 1388
title: –¢–æ —á—Ç–æ, –≤–æ–∑–º–æ–∂–Ω–æ, –í—ã –Ω–µ –∑–Ω–∞–ª–∏ –ø—Ä–æ Insert –≤ MySQL
date: 2014-08-18T13:38:18+00:00
author: admin

guid: http://www.tech-notes.net/?p=1388
permalink: /mysql-insert-trolo/
image: /wp-content/uploads/2014/02/MYSQL_Color_3.png
categories:
  - MySQL
---
–ö–∞–∂–¥—ã–π, –∫—Ç–æ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö `MySQL`, —Å—Ç–∞–ª–∫–∏–≤–∞–ª—Å—è —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º `INSERT`. –ù–æ –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ –≤—Å–µ, –¥–∞–∂–µ —Å–∞–º—ã–µ –æ–ø—ã—Ç–Ω—ã–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏, –∑–Ω–∞—é—Ç –∏ —É–º–µ—é—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é. –ù–∞ –ø—Ä–∏–º–µ—Ä–µ –¥–≤—É—Ö —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á —è —Ö–æ—á—É –≤–∞–º —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ —Ç–æ–Ω–∫–æ—Å—Ç—è—Ö —Ä–∞–±–æ—Ç—ã `insert`.

**–ó–∞–¥–∞—á–∞ 1.**

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–¥–µ–ª–∞—Ç—å —Å—á–µ—Ç—á–∏–∫ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –ø–æ IP –∞–¥—Ä–µ—Å–∞–º. –ï—Å–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ IP –∞–¥—Ä–µ—Å–∞ –µ—â–µ –Ω–µ—Ç—É, –µ–≥–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å, –∞ –µ—Å–ª–∏ –µ—Å—Ç—å - —É–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã –±—É–¥–µ—Ç —Å–ª–µ–¥—É—é—â–∞—è:

```sql
CREATE TABLE IF NOT EXISTS 'statTable' (
'ip' varchar(15) NOT NULL,
'visits' int(11) unsigned NOT NULL,
UNIQUE KEY 'ip' ('ip')
) ENGINE=MyISAM DEFAULT CHARSET=cp1251;
```

–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∑–∞–¥–∞—á—É –±—É–¥—É—Ç —Ä–µ—à–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

```php
$obj=$ourMysqli->query("select ip from statTable where ip='$ip'");
If ($obj->num_rows)
    $ourMysqli ->query("update statTable set visits=visits+1 where ip='$ip'");
else
   $ourMysqli ->query("insert into statTable (ip,visits) values('$ip',1)");
```


–ï—Å–ª–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞–ª–∏—á–∏—è –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ä–∞–∑—É `Insert` —ç—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—é –æ—à–∏–±–∫–∏ `"duplicate value in a UNIQUE index or PRIMARY KEY"`, –∞ `update` –±–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ä—è–¥–∞ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Ç–æ–º—É —á—Ç–æ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–µ –ø–æ—è–≤–∏—Ç—Å—è.

–†–µ—à–∞–µ—Ç —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É –≤ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è ON DUPLICATE KEY UPDATE. –ò—Å–ø–æ–ª—å–∑—É–µ–º –µ–µ —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

```php
$ourMysqli ->query("insert into statTable (ip,visits) values('$ip',1) on duplicate key update visits=visits+1");
```


`MySQL` –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ. –ü—Ä–µ–∂–¥–µ –æ–Ω –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Å—Ç–∞–≤–∫—É –Ω–æ–≤–æ–≥–æ —Ä—è–¥–∞. –ï—Å–ª–∏ –ø–æ–ª–µ —Å –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–º –∏–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏–Ω–¥–µ–∫—Å–æ–º —É–∂–µ –µ—Å—Ç—å, —Ç–æ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä—è–¥–∞. `Update statTable set visits=visits+1 where ip='$ip'`

–í —ç—Ç–æ–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –µ—Å—Ç—å –¥–≤–∞ –ø–æ–¥–≤–æ–¥–Ω—ã—Ö –∫–∞–º–Ω—è. –î–∞–≤–∞–π—Ç–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –∏—Ö.

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å 1:**  
–ò–∑–º–µ–Ω–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

```sql
CREATE TABLE IF NOT EXISTS `ipstat` (
  `ip` varchar(15) NOT NULL,
  `ref` varchar(100) NOT NULL,
  `visits` int(11) unsigned NOT NULL,
  PRIMARY KEY (`ref`),
  UNIQUE KEY `ip` (`ip`)
) ENGINE=MyISAM DEFAULT CHARSET=cp1251;
```


–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —É –Ω–∞—Å —Ç–∞–±–ª–∏—Ü–∞ –∏–º–µ–µ—Ç –¥–≤–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–∞ ip –∏ ref. –ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞

```php
$ourMysqli ->query("insert into statTable (ip,visits,ref) values('$ip',1,'$ref') on duplicate key update visits=visits+1");
```

–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π –≤–∏–¥:
```sql
update statTable set visits=visits+1 where ip='$ip' or ref='$ref' limit 1
```


–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ç–æ —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ —Ç–æ–ª—å–∫–æ –Ω–∞–¥ –ø–µ—Ä–≤–æ–π –Ω–∞–π–¥–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π, –æ—Ç–≤–µ—á–∞—é—â–µ–π —É—Å–ª–æ–≤–∏—é `ip='$ip' or ref='$ref'`

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å 2:**

–¢–∞–±–ª–∏—Ü–∞ –∏–º–µ–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π –≤–∏–¥:

```sql
CREATE TABLE IF NOT EXISTS `statTable` (
  `Id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `ip` varchar(15) NOT NULL,
  `visits` int(11) unsigned NOT NULL,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `ip` (`ip`),
  KEY `Id` (`Id`)
) ENGINE=MyISAM DEFAULT CHARSET=cp1251 AUTO_INCREMENT=1;
```

–ö –Ω–∞—à–µ–º—É —É–Ω–∏–∫–∞–ª—å–Ω–æ–º—É –∏–Ω–¥–µ–∫—Å—É IP –º—ã –µ—â–µ –¥–æ–±–∞–≤–∏–ª–∏ –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á, –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç Id. –ó–∞–ø—Ä–æ—Å –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

```php
$ourMysqli ->query("insert into statTable (ip,visits) values('$ip',1) on duplicate key update visits=visits+1");
```

–ï—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤ –∫–æ–Ω—Å–æ–ª–∏ —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å, –º—ã –ø–æ–ª—É—á–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ –¥–≤–∞ —Ä—è–¥–∞, –∞ –Ω–µ –æ–¥–∏–Ω.

–ü—Ä–∏—á–∏–Ω–∞ —Ç–∞–∫–æ–≥–æ, –∫–∞–∑–∞–ª–æ—Å—å –±—ã —Å—Ç—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è `MySQL`, –ø—Ä–æ—Å—Ç–∞. –°–Ω–∞—á–∞–ª–∞ –æ–Ω –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å `Insert` –∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç `auto_increment` –Ω–∞ –µ–¥–∏–Ω–∏—Ü—É. –ü–æ—Å–∫–æ–ª—å–∫—É –≤—Å—Ç–∞–≤–∫–∞ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è `update`, –Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞ —É–∂–µ —É–≤–µ–ª–∏—á–µ–Ω–æ –Ω–∞ –µ–¥–∏–Ω–∏—Ü—É.

–≠—Ç–∞ –æ—Å–æ–±–µ–Ω–Ω–æ –ø–ª–æ—Ö–æ, –µ—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –≤—ã—Å–æ–∫–æ –Ω–∞–≥—Ä—É–∂–µ–Ω, –ø–æ—Å–∫–æ–ª—å–∫—É –∑–Ω–∞—á–µ–Ω–∏—è –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞ –±—É–¥—É—Ç –∏—Å—á–µ—Ä–ø–∞–Ω—ã –≤ –¥–≤–∞ —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–π.

**–ó–∞–¥–∞—á–∞ 2.**

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤ —Ç–∞–±–ª–∏—Ü—É –∏–º–µ—é—â—É—é –∏–Ω–¥–µ–∫—Å `UNIQUE` –∏–ª–∏ `PRIMARY KEY` –¥–æ–±–∞–≤–∏—Ç—å —Ä—è–¥, —Ç–æ–ª—å–∫–æ –≤ —Ç–æ–º —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∏ —Å —Ç–∞–∫–∏–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –µ—â–µ –Ω–µ –Ω–µ—Ç—É.

–û–±—ã—á–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:

```php
$obj=$ourMysqli->query("select ip from statTable where ip='$ip'");
If (!$obj->num_rows)
   $ourMysqli ->query("insert into statTable set ip='$ip'");
```


–ï—Å–ª–∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –Ω–µ —Å–¥–µ–ª–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É, –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å—Ç—Ä–æ–∫–∏ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –≤ —Ç–∞–±–ª–∏—Ü–µ, –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –±—É–¥–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –ø–æ—Å–∫–æ–ª—å–∫—É `Insert` –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –æ—à–∏–±–∫–µ `duplicate value in a UNIQUE index or PRIMARY KEY`.

–î–ª—è —Ä–µ—à–µ–Ω–∏—è —ç—Ç–æ–π –ø—Ä–æ–±–ª–µ–º—ã –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é INSERT IGNORE. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –ø–æ–ª—É—á–∏—Ç—Å—è –≤–æ—Ç —Ç–∞–∫:

```php
$ourMysqli ->query("insert ignore into statTable set ip='$ip'");
```


MySQL –≤—Å–µ –¥–µ–ª–∞–µ—Ç –∑–∞ –Ω–∞—Å üôÇ

[–û—Ä–∏–≥–∏–Ω–∞–ª](http://freehost.com.ua/faq/articles/to-chto-vozmozhno-vi-ne-znali-pro-insert-v-mysql/)
